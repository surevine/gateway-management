@(destinations: List[Destination])

@import helper._

@scripts = {
	<script src="@routes.Assets.at("js/notifications.js")" type="text/javascript"></script>
}

@main("Destinations", scripts) {

	<a href="@routes.Destinations.add()" class="btn btn-primary primary-action">Add Destination</a>

    @if(destinations.isEmpty) {

		<div class="panel panel-warning">
		  <div class="panel-heading">
		    <h3 class="panel-title">No destinations</h3>
		  </div>
		  <div class="panel-body">
		    <p>No destinations have been configured. Please <a href="@routes.Destinations.add()">add a destination</a>.</p>
		  </div>
		</div>

    } else {

    	<div class="panel-group" id="destination-list" role="tablist" aria-multiselectable="true">

	    @for((destination, index) <- destinations.zipWithIndex) {

			<div class="panel panel-default">
			  <div class="panel-heading" role="tab" id="destination-heading-@index">
			    <h3 class="panel-title pull-left">
			    	<a data-toggle="collapse" data-parent="#destination-list" href="#destination-@index" aria-expanded="true" aria-controls="destination-@index">@destination.name</a>
			    	<span class="badge" data-toggle="tooltip" data-placement="top" title="@destination.federationConfigurations.length repositories federated">@destination.federationConfigurations.length</span>
			    </h3>
				<div class="clearfix"></div>
			  </div>
			  <div id="destination-@index" class="panel-collapse collapse @if(index == 0) { in }" role="tabpanel" aria-labelledby="destination-heading-@index">
				  <div class="panel-body">

				  	<table class="destination-info">
						<tr>
							<th>URL</th>
							<td>@destination.url</td>
						</tr>
						<tr>
							<th>Source key</th>
							<td>@destination.sourceKey</td>
						</tr>
					</table>

					<section class="shared-repos">
						<div role="tabpanel">
							<ul class="nav nav-tabs" role="tablist">
							    <li role="presentation" class="active"><a href="#all-@destination.id" aria-controls="all-@destination.id" role="tab" data-toggle="tab">All</a></li>
							    <li role="presentation"><a href="#scm-@destination.id" aria-controls="scm-@destination.id" role="tab" data-toggle="tab">SCM</a></li>
							    <li role="presentation"><a href="#issues-@destination.id" aria-controls="issues-@destination.id" role="tab" data-toggle="tab">Issue-tracking</a></li>
						  	</ul>
						 	<div class="tab-content">
							    <div role="tabpanel" class="tab-pane active" id="all-@destination.id">
									@utils.renderFederatedRepos(destination, "ALL")
							    </div>
							    <div role="tabpanel" class="tab-pane" id="scm-@destination.id">
							    	@utils.renderFederatedRepos(destination, "SCM")
							    </div>
							    <div role="tabpanel" class="tab-pane" id="issues-@destination.id">
									@utils.renderFederatedRepos(destination, "ISSUE")
								</div>
						    </div>
					    </div>
				    </section>
				  </div>
				  <div class="panel-footer">
				  	<a href="@routes.Destinations.federateRepoPage(destination.id)" class="btn btn-primary btn-sm">Federate repository</a>
				  	<a href="@routes.Destinations.edit(destination.id)" class="btn btn-default btn-sm">Edit destination</a>
				  	<a href="@routes.Destinations.editRules(destination.id)" class="btn btn-default btn-sm">Configure destination rules</a>
				  </div>
			  </div>
			</div>

	    }

	    <script type="text/javascript">
			$( document ).ready(function() {

				// Initialise tooltips
				$('[data-toggle="tooltip"]').tooltip();

				// Initialise resend ajax requests
				$('.resend').on('click', function () {

				    var $btn = $(this).button('loading');

					$.ajax({
						url: "@routes.FederationConfigurations.resend()",
						type: "POST",
						data: {
							configurationId: $btn.data("configuration-id")
						},
						success: function(data){
							notifications.success(data);
						},
						error: function(data){
							notifications.error(data.responseText);
						}
					}).always(function(){
						 $btn.button('reset');
					});
				});

				// Initialise federation update ajax requests
				$('.federation').on('click', function () {

				    var $btn = $(this).button('loading');
					var configId = $btn.data("configuration-id");
			  		var direction = $btn.data("direction");

				    // Desired state is inverse of current state (as toggle control)
				    var setActive = !$btn.hasClass("active");

					$.ajax({
						url: "@routes.FederationConfigurations.update()",
						type: "POST",
						data: {
							configurationId: $btn.data("configuration-id"),
							direction: $btn.data("direction"),
							enable: setActive
						},
						success: function(data){
							var $toggleButtons = $('.federation[data-direction="' + direction + '"][data-configuration-id="'+configId+'"]');
							if(setActive) {
								$toggleButtons.addClass("active");
							} else {
								$toggleButtons.removeClass("active");
							}
						},
						error: function(data){
							notifications.error(data.responseText);
						}
					}).always(function(){
						 $btn.button('reset');
					});
				});

			});
		</script>

    }

}
